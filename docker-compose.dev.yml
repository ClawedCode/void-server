# Development Docker Compose
# Usage: docker compose -f docker-compose.dev.yml up
#
# This configuration mounts source code as volumes for development.
# Changes to server/ and client/src/ are reflected without rebuilding.
# Restart container to apply server changes: docker compose -f docker-compose.dev.yml restart void-server

services:
  void-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: void-server-dev
    restart: unless-stopped
    group_add:
      - ${DOCKER_GID:-0}
    ports:
      - "4420:4401"  # Main application
      - "4480:4480"  # Vite dev server (if needed)
    environment:
      - NODE_ENV=development
      - PORT=4401
      # Neo4j connection
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-voidserver}
      - NEO4J_DATABASE=neo4j
      # Optional: LM Studio running on host machine
      - LM_STUDIO_URL=${LM_STUDIO_URL:-http://host.docker.internal:1234/v1}
      # LM Studio models path for importing into Ollama
      - LM_STUDIO_MODELS_PATH=/lm-studio-models
      # Ollama connection
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434/v1}
      # IPFS connection
      - IPFS_API_URL=http://ipfs:5001
      - IPFS_GATEWAY_URL=http://ipfs:8080
      # Watchtower API
      - WATCHTOWER_URL=http://watchtower:8080
      - WATCHTOWER_TOKEN=${WATCHTOWER_TOKEN:-void-update-token}
      # Browser sidecar configuration
      - BROWSER_CONTAINER_IMAGE=${BROWSER_CONTAINER_IMAGE:-ghcr.io/clawedcode/void-server/void-browser:latest}
      - BROWSER_NOVNC_PORT=${BROWSER_NOVNC_PORT:-6080}
      - BROWSER_IDLE_TIMEOUT=${BROWSER_IDLE_TIMEOUT:-900000}
      - BROWSER_DATA_PATH=${PWD}/data/browsers
    volumes:
      # Source code mounts for development (read-only to prevent accidental writes)
      - ./server:/app/server:ro
      - ./client/src:/app/client/src:ro
      - ./client/public:/app/client/public:ro
      - ./plugins:/app/plugins:ro
      # Persistent data directories (read-write)
      - ./config:/app/config
      - ./backups:/app/backups
      - ./logs:/app/logs
      - ./data:/app/data
      # Docker socket for browser sidecar management
      - /var/run/docker.sock:/var/run/docker.sock
      # LM Studio models directory for importing
      - ${LM_STUDIO_MODELS_PATH:-./data/lm-studio-models}:/lm-studio-models:ro
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - void-network
    labels:
      - "com.centurylinklabs.watchtower.enable=false"  # Disable auto-updates in dev

  neo4j:
    image: neo4j:5-community
    container_name: void-neo4j-dev
    restart: unless-stopped
    ports:
      - "4421:7474"
      - "4422:7687"
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-voidserver}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j_data_dev:/data
      - neo4j_logs_dev:/logs
    networks:
      - void-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  ipfs:
    image: ipfs/kubo:latest
    container_name: void-ipfs-dev
    restart: unless-stopped
    ports:
      - "4423:5001"
      - "4424:8080"
    environment:
      - IPFS_PROFILE=server
      - IPFS_TELEMETRY=off
    volumes:
      - ipfs_data_dev:/data/ipfs
    networks:
      - void-network
    healthcheck:
      test: ["CMD-SHELL", "ipfs id || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  void-network:
    driver: bridge

volumes:
  neo4j_data_dev:
    driver: local
  neo4j_logs_dev:
    driver: local
  ipfs_data_dev:
    driver: local
